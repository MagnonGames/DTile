<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="dtile-three-renderer">
	<template>
		<style>
			:host, #renderer {
				display: block;
				position: absolute;
				top: 0; right: 0; bottom: 0; left: 0;
				width: 100%;
				height: 100%;
				background: transparent;
			}
		</style>
		<canvas id="renderer"></canvas>
	</template>

	<script src="../../node_modules/dtile-three-renderer/out/js/build.js"></script>

	<script>
		/* globals dtileThreeRenderer */
		const MAX_ZOOM = 1,
			MIN_ZOOM = 0.001;

		Polymer({
			is: "dtile-three-renderer",

			properties: {
				map: Object,

				panX: {
					type: Number,
					value: 0,
					reflectToAttribute: true
				},
				panY: {
					type: Number,
					value: 0,
					reflectToAttribute: true
				},
				zoom: {
					type: Number,
					value: 1,
					reflectToAttribute: true
				}
			},

			observers: [
				"changeMap(map)",
				"updateCamera(panX, panY, zoom)"
			],

			attached() {
				if (window.mocha) {
					dtileThreeRenderer.Renderer.enableTesting();
				}

				this.renderer = new dtileThreeRenderer.Renderer(this.$.renderer, true);

				this.updateCamera(this.panX, this.panY, this.zoom);
			},

			changeMap(map) {
				this.renderer.changeMap(map);
			},

			getTileAtMouse(position, layerId) {
				return this.renderer.getTileAtMouse(position, layerId);
			},

			updateCamera(panX, panY, zoom) {
				if (!this.renderer) return;

				this.renderer.camera.zoom = Math.pow(zoom, 2) * (MAX_ZOOM - MIN_ZOOM) + MIN_ZOOM;
				this.renderer.camera.position.set(
					panX,
					panY,
					this.renderer.camera.position.z
				);

				this.update({
					camera: true
				});
			},

			update(toUpdate) {
				// TODO: Somehow throttle this with requestAnimationFrame
				this.renderer.update(toUpdate);
			}
		});
	</script>
</dom-module>
