<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../utils.html">

<link rel="import" href="../dtile-state/import.html">

<dom-module id="dtile-project-view">
    <template>
        <style>
            #main-container {
                color: white;
                margin: 50px;
            }

            #maps-container {
                display: flex;
                flex-wrap: wrap;
                margin: 0 -30px;
            }

            #maps-container > paper-card {
                flex: 0 0 calc(33.3% - 60px);
                margin: 30px;
            }

            paper-card > .card-actions {
                border-top: 1px solid rgba(255, 255, 255, 0.12);
            }
        </style>

        <div id="main-container">
            <h1>[[projectName]]</h1>
            <paper-icon-button icon="add" on-tap="_addMap"></paper-icon-button>
            <paper-button on-tap="_openTilesetImport">Add Tileset</paper-button>
            <div id="maps-container">
                <template is="dom-repeat" items="{{maps}}">
                    <paper-card>
                        <div class="card-content">
                            <h2>[[item.name]]</h2>
                        </div>
                        <div class="card-actions">
                            <paper-icon-button
                                icon="delete"
                                on-tap="_removeMap">
                            </paper-icon-button>
                            <paper-button on-tap="_openMap">Open</paper-button>
                        </div>
                    </paper-card>
                </template>
            </div>
        </div>
    </template>
</dom-module>

<script>
    class DTileProjectView extends DTile.ReduxMixin(Polymer.Element) {
        static get is() { return "dtile-project-view"; }

        static get properties() {
            return {
                maps: {
                    type: Array,
                    statePath(state) {
                        return Object.keys(state.entities.maps).map(id => {
                            return {
                                ...state.entities.maps[id].present,
                                id
                            };
                        });
                    }
                },

                projectId: {
                    type: String,
                    statePath: state => state.ui.currentProjectId
                },
                projectName: {
                    type: String,
                    statePath(state) {
                        const project = state.entities.projects[state.ui.currentProjectId];
                        if (project) return project.name;
                    }
                }
            };
        }

        static get actions() {
            return {
                importMap(projectId, map) {
                    const maps = DTile.store.getState().entities.maps;
                    const mapId = DTile.stateHelpers.lastId(maps);
                    return {
                        type: "ADD_MAP",
                        payload: { projectId, mapId, ...map }
                    };
                },

                removeMap(map) {
                    return {
                        type: "REMOVE_MAP",
                        payload: { mapId: map.id }
                    };
                },

                importTileset(tilesetId, tileset) {
                    return {
                        type: "IMPORT_TILESET",
                        payload: { tilesetId, ...tileset }
                    };
                },

                addTilesetToProject(projectId, tilesetId) {
                    return {
                        type: "ADD_TILESET_TO_PROJECT",
                        payload: { projectId, tilesetId }
                    };
                }
            };
        }

        ready() {
            super.ready();

            this.addEventListener("dtile-file-import", ({ detail: { files }}) => {
                files.forEach(async (file) => {
                    const jsonContent = await DTile.utils.readFileAsText(file);
                    const mapObject = JSON.parse(jsonContent);

                    const tilesetIdMapping = new Map();

                    mapObject.tilesets.forEach((tileset, i) => {
                        const tilesets = DTile.store.getState().entities.tilesets;
                        const newId = DTile.stateHelpers.lastId(tilesets);

                        tilesetIdMapping.set(i, newId);

                        this.dispatch("importTileset", newId, tileset);
                        this.dispatch("addTilesetToProject", this.projectId, newId);
                    });

                    mapObject.layers = mapObject.layers.map(layer => {
                        layer.tiles = layer.tiles.map(tile => {
                            tile.tilesetId = tilesetIdMapping.get(tile.tilesetId);
                            return tile;
                        });
                        return layer;
                    });

                    this.dispatch("importMap", this.projectId, mapObject);
                });
            });
        }

        _addMap(name) {
            this.dispatch("setCurrentPage", "new-map");
        }

        _removeMap(e) {
            this.dispatch("removeMap", e.model.item);
        }

        _openMap(e) {
            this.dispatch("setCurrentMapId", e.model.item.id);
            this.dispatch("setCurrentPage", "edit-map");
        }

        _openTilesetImport() {
            this.dispatch("setCurrentPage", "import-tileset");
        }
    }

    customElements.define(DTileProjectView.is, DTileProjectView);
</script>
