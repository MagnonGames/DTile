<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">

<link rel="import" href="../dtile-state/import.html">

<dom-module id="dtile-projects-view">
    <template>
        <style>
            #main-container {
                color: white;
                padding: 50px;
                box-sizing: border-box;
            }

            #projects-container {
                display: flex;
                flex-wrap: wrap;
                margin: 0 -30px;
            }

            #projects-container > paper-card {
                flex: 1 1 300px;
                margin: 30px;
            }

            paper-card > .card-actions {
                border-top: 1px solid rgba(255, 255, 255, 0.12);
            }

            paper-card .card-header {
                display: flex;
                align-items: center;
            }

            paper-card .card-header > h2 {
                flex-grow: 1;
            }
        </style>

        <div id="main-container">
            <h1>DTile Projects</h1>
            <paper-icon-button icon="add" on-tap="_addProject"></paper-icon-button>
            <div id="projects-container">
                <template is="dom-repeat" items="{{projects}}">
                    <paper-card>
                        <div class="card-content">
                            <div class="card-header">
                                <h2>[[item.name]]</h2>
                                <paper-menu-button>
                                    <paper-icon-button icon="more-vert"
                                        slot="dropdown-trigger">
                                    </paper-icon-button>

                                    <div slot="dropdown-content">
                                        <paper-item on-tap="_renameProject">Rename</paper-item>
                                    </div>
                                </paper-menu-button>
                            </div>
                        </div>
                        <div class="card-actions">
                            <paper-icon-button
                                icon="delete"
                                on-tap="_removeProject">
                            </paper-icon-button>
                            <paper-button on-tap="_openProject">Open</paper-button>
                        </div>
                    </paper-card>
                </template>
            </div>
        </div>
    </template>
</dom-module>

<script>
    class DTileProjectsView extends DTile.ReduxMixin(Polymer.Element) {
        static get is() { return "dtile-projects-view"; }

        static get properties() {
            return {
                projects: {
                    type: Object,
                    statePath(state) {
                        return Object.keys(state.entities.projects).map(id => {
                            return {
                                ...state.entities.projects[id],
                                id
                            };
                        });
                    }
                }
            };
        }

        static get actions() {
            return {
                addProject(name) {
                    const projects = DTile.store.getState().entities.projects;
                    const projectId = DTile.stateHelpers.lastId(projects);
                    name = name || `Project ${projectId + 1}`;
                    return {
                        type: "ADD_PROJECT",
                        payload: { name, projectId }
                    };
                },

                removeProject(project) {
                    return {
                        type: "REMOVE_PROJECT",
                        payload: { projectId: project.id }
                    };
                },

                renameProject(projectId, name) {
                    return {
                        type: "RENAME_PROJECT",
                        payload: { projectId, name }
                    };
                }
            };
        }

        _addProject() {
            this.dispatch("addProject");
        }

        _removeProject(e) {
            const toRemove = e.model.item;
            this.dispatch("removeProject", toRemove);
        }

        _renameProject(e) {
            // Close paper-menu-button
            e.target.parentElement.parentElement.close();

            this.dispatchEvent(new CustomEvent("rename", {
                composed: true,
                bubbles: true,
                detail: {
                    itemType: "Project",
                    currentName: e.model.item.name,
                    callback: ({ newName }) => {
                        this.dispatch("renameProject", e.model.index, newName);
                    }
                }
            }));
        }

        _openProject(e) {
            this.dispatch("setCurrentProjectId", e.model.item.id);
            this.dispatch("setCurrentPage", { page: "project" });
        }
    }

    customElements.define(DTileProjectsView.is, DTileProjectsView);
</script>
