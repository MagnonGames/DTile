<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../bower_components/app-layout/app-layout.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/all-imports.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">

<link rel="import" href="../../bower_components/file-input/file-input.html">

<link rel="import" href="../dtile-tilemap-editor/dtile-tilemap-editor.html">
<link rel="import" href="../dtile-tileset-selector/dtile-tileset-selector.html">
<link rel="import" href="../dtile-dialogs/dtile-tileset-import-dialog.html">
<link rel="import" href="../dtile-dialogs/dtile-new-map-dialog.html">
<link rel="import" href="../dtile-dialogs/dtile-map-import-dialog.html">
<link rel="import" href="../dtile-dialogs/dtile-property-dialog.html">
<link rel="import" href="../dtile-layer-list/dtile-layer-list.html">
<link rel="import" href="../dtile-tool-selector/dtile-tool-selector.html">
<link rel="import" href="../dtile-storage/dtile-storage.html">
<link rel="import" href="../dtile-status-indicator/dtile-status-indicator.html">
<link rel="import" href="../dtile-action-manager/dtile-action-manager.html">
<link rel="import" href="../dtile-project-outliner/dtile-project-outliner.html">

<dom-module id="dtile-app">
	<template>
		<style>
			/* Google Fonts */
			@font-face {
				font-family: 'Noto Sans';
				font-style: normal;
				font-weight: 400;
				src: local('Noto Sans'), local('NotoSans'), url(https://fonts.gstatic.com/s/notosans/v6/LeFlHvsZjXu2c3ZRgBq9nKCWcynf_cDxXwCLxiixG1c.ttf) format('truetype');
			}

			:host {
				display: block;
				width: 100%;
				height: 100%;
				font-family: 'Noto Sans', sans-serif;

				background: var(--page-background-color);

				--primary-color: var(--paper-purple-500);
				--accent-color: var(--paper-cyan-a400);

				--primary-text-color: white;
				--secondary-text-color: rgba(255, 255, 255, 0.7);
				--contrasting-text-color: white;

				--primary-background-color: #424242;
				--page-background-color: #303030;
			}

			#tilemapContainer {
				display: block;
				width: 100%;
				height: 100%;
			}

			app-toolbar {
				color: var(--contrasting-text-color);
				background: var(--primary-color);
			}

			#tabToolbar {
				height: 48px;
			}

			.mapTabName {
				flex-grow: 1;
			}

			paper-icon-button + [main-title] {
				margin-left: 24px;
			}

			app-drawer {
				--app-drawer-content-container: {
					background: var(--primary-background-color);
				}
			}

			#mainDrawer {
				--app-drawer-width: 300px;
			}

			#rightDrawer {
				z-index: 10;
				--app-drawer-content-container: {
					background: var(--primary-background-color);
					padding-top: calc(120px + 112px); /* 120px is default (apparently) and the toolbar is 112px */
				}
				--app-drawer-width: 350px;
			}

			#tilesetIdSelector, #tilesetIdSelector paper-menu-button {
				padding: 0 16px;
				box-sizing: border-box;
				width: 100%;
				--paper-menu-button-dropdown: {
					width: calc(100% - 32px);
				}
			}

			footer {
				pointer-events: none;
				position: absolute;
				bottom: 10px;
				left: 0; right: 0;
				text-align: center;
				color: white;
				opacity: 0.6;
			}
		</style>
		<style is="custom-style" include="iron-positioning"></style>

		<app-drawer-layout fullbleed force-narrow>
			<app-drawer id="mainDrawer" swipe-open>
				<paper-listbox selectable=".nothing">
					<paper-icon-item on-tap="createNewProject">
						<iron-icon icon="add" item-icon></iron-icon>
						New Project
					</paper-icon-item>
					<paper-icon-item on-tap="requestCreateMap">
						<iron-icon icon="add" item-icon></iron-icon>
						New Map
					</paper-icon-item>
					<paper-icon-item>
						<iron-icon icon="add" item-icon></iron-icon>
						<file-input id="mapFileInput" accept="application/json"
							extensions="[&quot;json&quot;]" max-files="1" on-change="_requestMapImport">
						</file-input>
						Import Map
					</paper-icon-item>
					<paper-icon-item>
						<iron-icon icon="add" item-icon></iron-icon>
						<file-input id="tilesetFileInput" accept="image/*,application/json"
						 	max-files="1" on-change="requestTilesetImport">
						</file-input>
						Import Tileset
					</paper-icon-item>
					<paper-icon-item on-tap="exportMap">
						<iron-icon icon="file-download" item-icon></iron-icon>
						Export Map
					</paper-icon-item>
				</paper-listbox>

				<dtile-project-outliner id="projectOutliner" projects="[[projects]]">
				</dtile-project-outliner>
			</app-drawer>

			<app-header-layout fullbleed>
				<app-header shadow fixed>
					<app-toolbar>
						<paper-icon-button icon="menu" on-tap="toggleMainDrawer"></paper-icon-button>
						<div main-title>DTile</div>
						<paper-icon-button icon="undo" on-tap="_undo"></paper-icon-button>
						<paper-icon-button icon="redo" on-tap="_redo"></paper-icon-button>
						<dtile-status-indicator status="[[saveStatus]]"></dtile-status-indicator>
					</app-toolbar>
					<app-toolbar id="tabToolbar">
						<paper-tabs selected="{{currentMapIndex}}"
							bottom-item scrollable fit-container>
							<template is="dom-repeat" items="[[openMaps]]">
								<paper-tab>
									<span class="mapTabName">[[item.name]]</span>
									<paper-icon-button icon="close" on-tap="_closeTab">
									</paper-icon-button>
								</paper-tab>
							</template>
						</paper-tabs>
					</app-toolbar>
				</app-header>

				<div id="tilemapContainer">
					<dtile-tilemap-editor id="renderer" map="[[_map]]"
						outline="[[showOutline]]" current-tool="[[currentTool]]"
						current-tile-area="[[selectedTileArea]]"
						current-layer="[[currentLayer]]">
					</dtile-tilemap-editor>
				</div>

				<iron-media-query query="(max-width: 960px)" query-matches="{{smallScreen}}"></iron-media-query>
				<app-drawer id="rightDrawer" align="end" opened="[[!smallScreen]]"
					swipe-open="[[smallScreen]]" persistent="[[!smallScreen]]">
					<dtile-tool-selector current-tool="{{currentTool}}"
						wireframe="{{showOutline}}"></dtile-tool-selector>
					<dtile-layer-list layers="{{_map.layers}}" current-selected="{{currentLayer}}" id="layerList"></dtile-layer-list>
					<paper-dropdown-menu label="Tileset" id="tilesetIdSelector">
						<paper-listbox class="dropdown-content" selected="{{currentTileset}}">
							<template is="dom-repeat" items="{{_map.tilesets}}">
								<paper-item>[[item.name]]</paper-item>
							</template>
						</paper-listbox>
					</paper-dropdown-menu>
					<dtile-tileset-selector map="[[_map]]" selected-tile-area="{{selectedTileArea}}"
						tileset-id="[[currentTileset]]"></dtile-tileset-selector>
				</app-drawer>

				<footer>
					Build: [[version]]
				</footer>
			</app-header-layout>
		</app-drawer-layout>

		<dtile-tileset-import-dialog id="tilesetImportDialog"></dtile-tileset-import-dialog>
		<dtile-new-map-dialog id="mapCreateDialog"></dtile-new-map-dialog>
		<dtile-map-import-dialog id="mapImportDialog"></dtile-map-import-dialog>
		<dtile-property-dialog id="propertyDialog"></dtile-property-dialog>

		<dtile-storage id="storage" projects="{{projects}}"></dtile-storage>
		<dtile-action-manager id="actionManager"></dtile-action-manager>
	</template>

	<script src="../../node_modules/dtile-tilemap/out/js/build.js"></script>
	<script src="../../node_modules/file-saver/FileSaver.min.js"></script>

	<script>
		/* globals dtileTilemap, saveAs */
		Polymer({
			is: "dtile-app",

			properties: {
				projects: {
					type: Array,
					value: () => []
				},

				openMaps: {
					type: Array,
					value: []
				},
				currentMapIndex: Number,

				_map: {
					type: Object,
					computed: "_getCurrentMap(openMaps, currentMapIndex, openMaps.*)"
				},
				_currentProjectName: {
					type: String,
					computed: "_getProjectNameForMap(_map)"
				},
				showOutline: Boolean,
				currentTool: {
					type: String,
					value: "pen"
				},
				currentTileset: {
					type: Number,
					value: -1
				},
				currentLayer: {
					type: Number,
					value: 0
				},

				smallScreen: Boolean,

				saveStatus: String,

				version: {
					type: String,
					value: "__VERSION__",
					readOnly: true
				}
			},

			listeners: {
				"tilesetImportDialog.tileset-import": "addTileset",
				"add-map": "createAndAddMap",
				"layerList.layers-changed": "updateLayers",
				"add-layer": "_addLayer",
				"map-changed": "_mapUpdated",
				"projectOutliner.select": "_onProjectOutlinerSelect",
				"storage.progress-done": "_saveDone",
				"storage.progress-failed": "_saveFailed",
				"storage.config-restored": "_restoreConfig",

				"edit-action": "_addAction",

				"show-properties": "_showProperties",

				"mousemove": "_handleMouseMove"
			},

			observers: [
				"_mapUpdated(_map)",
				"_saveOpenMapsState(openMaps, currentMapIndex)"
			],

			attached() {
				this._keyEvent = this._keyEvent || this._handleKey.bind(this);
				window.addEventListener("keypress", this._keyEvent);
			},
			detached() {
				if (!this._keyEvent) return;
				window.removeEventListener("keypress", this._keyEvent);
			},

			toggleMainDrawer() {
				this.$.mainDrawer.toggle();
			},

			openMap(projectName, mapName) {
				const map = this.$.storage.getMap(projectName, mapName);
				const openIndex = this.openMaps.indexOf(map);

				if (openIndex < 0) {
					// Map not opened
					this.push("openMaps", map);
					this.currentMapIndex = this.openMaps.length - 1;
				} else {
					// Map already added to opened maps
					this.currentMapIndex = openIndex;
				}
			},

			updateLayers() {
				this.$.renderer.fire("update-map");
			},

			createNewProject() {
				this.$.storage.createProject(); // TODO: Name
				this.$.storage.saveProjects();
			},

			requestCreateMap() {
				this.$.mapCreateDialog.open();
				this.$.mainDrawer.close();
			},

			requestTilesetImport() {
				this.$.tilesetImportDialog.setImage(this.$.tilesetFileInput.files[0]);
				this.$.tilesetImportDialog.open();
				this.$.mainDrawer.close();
			},

			createAndAddMap(e) {
				this.$.storage.createMap("Project", e.detail);
				this.$.storage.saveProjects();
			},

			addTileset(e) {
				const tileset = new dtileTilemap.TileSet({
					name: e.detail.name,
					type: "image",
					virtualPath: e.detail.imageURL
				});
				this._map.addTileset(tileset);
				this.$.renderer.fire("tileset-added");
				this.fire("map-changed");

				this.currentTileset = this._map.tilesets.length - 1;

				this.notifySplices("_map.tilesets", [
					{ index: this.currentTileset, addedCount: 1, removed: [], object: this._map.tilesets, type: "splice" }
				]);

				this.$.storage.saveTilesetsForProject(this._currentProjectName);
			},

			exportMap() {
				const json = this._map.getJSON();
				const blob = new Blob([json], { type: "text/plain;charset=utf-8" });
				saveAs(blob, `${this._map.name}.json`);
			},

			saveCurrentMap() {
				if (!this._currentProjectName || !this._map) return;
				this.$.storage.saveMap(this._currentProjectName, this._map.name);
			},

			_restoreConfig(e) {
				const { openMaps = [], openIndex = 0 } = e.detail;

				this.openMaps = openMaps;
				this.currentMapIndex = openIndex;
			},

			_getCurrentMap(openMaps, index) {
				return openMaps[index];
			},

			_getProjectNameForMap(map) {
				return this.$.storage.findProjectForMap(map).name;
			},

			_onProjectOutlinerSelect(e) {
				this.openMap(e.detail.parentName, e.detail.item.name);
			},

			_addLayer(e) {
				this._map.createLayer({
					name: e.detail.name
				});
				this.notifySplices("_map.layers", [
					{ index: this._map.layers.length - 1, addedCount: 1, removed: [],
						object: this._map.layers, type: "splice" }
				]);

				this.updateLayers();
			},

			_mapUpdated() {
				this.saveStatus = "activity";
				if (this.saveTimeout) window.clearTimeout(this.saveTimeout);
				this.saveTimeout = window.setTimeout(() => {
					this.saveCurrentMap();
				}, 1500);
			},

			_saveOpenMapsState(openMaps, openIndex) {
				this.$.storage.saveConfig({ openMaps, openIndex });
			},

			_saveStarted() {
				this.saveStatus = "activity";
			},

			_saveDone() {
				this.saveStatus = "done";
			},

			_saveFailed() {
				this.saveStatus = "failed";
			},

			_requestMapImport(e) {
				const mapFile = this.$.mapFileInput.files[0];
				if (!mapFile) return;

				const fileReader = new FileReader();

				fileReader.onload = () => {
					const mapObject = JSON.parse(fileReader.result);
					const map = new dtileTilemap.TileMap(mapObject);

					this.$.mapImportDialog.map = map;
					this.$.mapImportDialog.open();

					this.$.mainDrawer.close();
				};

				fileReader.readAsText(mapFile);
			},

			_importMap(e) {
				this.createNewMap(e.detail);
			},

			_addAction(e) {
				this.$.actionManager.add(e.detail);
			},

			_undo() {
				this.$.actionManager.undo();
				this.$.renderer.fire("update-map");
			},

			_redo() {
				this.$.actionManager.redo();
				this.$.renderer.fire("update-map");
			},

			_showProperties({ detail: { propertyObjects } }) {
				this.$.propertyDialog.propertyObjects = propertyObjects;
				this.$.propertyDialog.opened = true;
			},

			_handleKey(e) {
				const stop = () => {
					e.preventDefault();
					e.stopPropagation();
				};
				const isEditorDecendant = this._keyFocused
					? this._keyFocused.path.includes(this.$.renderer) : false;

				if (e.ctrlKey && e.code === "KeyZ") {
					if (e.shiftKey) {
						this._redo();
					} else {
						this._undo();
					}
					stop(); return;
				}

				if (isEditorDecendant) {
					if (e.code === "KeyA") { // Pen
						this.currentTool = "pen"; stop(); return;
					} else if (e.code === "KeyS") { // Fill
						this.currentTool = "fill"; stop(); return;
					} else if (e.code === "KeyD") { // Select
						this.currentTool = "selection"; stop(); return;
					}
				}

				if (!this._keyFocused) return;
				this.fire("virtual-key-down", {
					key: e.key,
					code: e.code
				}, { node: this._keyFocused.root });
			},
			_handleMouseMove(e) {
				e = Polymer.dom(e);
				this._keyFocused = {
					path: e.path,
					root: e.rootTarget
				};
			},

			_closeTab(e) {
				e.preventDefault();
				e.stopPropagation();

				const closingEndItem = e.model.index === this.openMaps.length - 1;
				const closingCurrent = this.currentMapIndex === e.model.index;

				if (closingEndItem && closingCurrent) this.currentMapIndex--;

				this.splice("openMaps", e.model.index, 1);

				this._saveOpenMapsState(this.openMaps, this.currentMapIndex);
			}
		});
	</script>
</dom-module>
