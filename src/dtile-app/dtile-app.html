<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../bower_components/app-layout/app-layout.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/all-imports.html">

<link rel="import" href="../../bower_components/file-input/file-input.html">

<link rel="import" href="../dtile-three-renderer/dtile-three-renderer.html">

<dom-module id="dtile-app">
	<template>
		<style>
			:host {
				display: block;
			}

			#renderer {
				background: #303030;
			}

			app-toolbar {
				color: white;
				background: var(--paper-blue-grey-500);
			}

			paper-icon-button + [main-title] {
				margin-left: 24px;
			}
		</style>
		<style is="custom-style" include="iron-positioning"></style>

		<app-drawer-layout fullbleed>
			<app-drawer swipe-open align="end">
				<app-toolbar></app-toolbar>
				Layer and tileselection coming to this drawer soon!
			</app-drawer>

			<app-drawer id="mainDrawer" swipe-open>
				<paper-listbox selectable=".nothing">
					<paper-icon-item>
						<iron-icon icon="add" item-icon></iron-icon>
						<file-input id="mapFileInput" accept="application/json"
							extensions="[&quot;json&quot;]" max-files="1" on-change="updateMap">
						</file-input>
						Import Map
					</paper-icon-item>
				</paper-listbox>
				<paper-spinner id="mapSpinner"></paper-spinner>
			</app-drawer>

			<app-header-layout fullbleed>
				<app-header fixed shadow>
					<app-toolbar>
						<paper-icon-button icon="menu" on-tap="toggleMainDrawer"></paper-icon-button>
						<div main-title>DTile</div>
					</app-toolbar>
				</app-header>

				<div>
					<dtile-three-renderer id="renderer" map="[[_map]]"></dtile-three-renderer>
				</div>
			</app-header-layout>
		</app-drawer-panel>
	</template>

	<script src="../../node_modules/dtile-tilemap/out/js/build.js"></script>

	<script>
		/* globals dtileTilemap */
		Polymer({
			is: "dtile-app",

			properties: {
				_map: Object
			},

			listeners: {
				"renderer.tap": "rendererTap",
				"renderer.wheel": "rendererScroll"
			},

			toggleMainDrawer() {
				this.$.mainDrawer.toggle();
			},

			updateMap() {
				const mapFile = this.$.mapFileInput.files[0];
				if (!mapFile) return;

				this.$.mapSpinner.active = true;

				const fileReader = new FileReader();

				fileReader.onload = () => {
					const mapObject = JSON.parse(fileReader.result);

					this._map = new dtileTilemap.TileMap(mapObject);
					this.$.renderer.update({ tiles: true });
					this.$.mapSpinner.active = false;
					this.$.mainDrawer.close();
				};

				fileReader.readAsText(mapFile);
			},

			rendererTap(e) {
				const pos = this.$.renderer.getTileAtMouse(this._toLocalRendererPos(e.detail), 0);
				if (!pos) return;
				const tile = this._map.layers[0].getTileArea(pos.x, pos.y, 1, 1).tiles[0];
				if (tile) tile.tileId = -1;
				this.$.renderer.update({ tiles: true });
			},

			rendererScroll(e) {
				e.preventDefault();
				e.stopPropagation();

				if (e.ctrlKey) {
					this.$.renderer.zoom = Math.max(0, Math.min(1, this.$.renderer.zoom + e.deltaY * -0.0003));
				} else {
					// Add .001 to make sure invZoom !== 0
					const invZoom = this.$.renderer.zoom * -1 + 1.001;
					this.$.renderer.panX += e.deltaX * invZoom * 0.5;
					this.$.renderer.panY += e.deltaY * invZoom * 0.5;
				}
				this.$.renderer.update({ camera: true });
			},

			_toLocalRendererPos(pos) {
				const rect = this.$.renderer.getBoundingClientRect();
				pos.x -= rect.left;
				pos.y -= rect.top;
				return pos;
			}
		});
	</script>
</dom-module>
