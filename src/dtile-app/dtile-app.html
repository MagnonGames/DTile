<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../dtile-shell/dtile-shell.html">
<link rel="import" href="projects-view.html">
<link rel="import" href="project-view.html">
<link rel="import" href="../dtile-map-editor/dtile-map-editor.html">

<dom-module id="dtile-app">
    <template>
        <style>
            :host, dtile-shell, iron-pages, iron-pages > * {
                display: block;
                width: 100%;
                height: 100%;
            }
        </style>

        <app-location id="location" route="{{route}}"></app-location>
        <app-route
            route="{{route}}"
            pattern="/:pageName"
            data="{{pageData}}"
            tail="{{subroute}}">
        </app-route>
        <app-route
            route="{{subroute}}"
            pattern="/:content"
            data="{{pageContentData}}">
        </app-route>

        <dtile-shell>
            <iron-pages selected="[[page]]" attr-for-selected="page">
                <dtile-projects-view page="projects"></dtile-projects-view>
                <dtile-project-view project-id="[[projectId]]" page="project"></dtile-project-view>
                <span page="tilesets">Tilesets</span>
                <dtile-map-editor map-id="[[mapId]]" page="edit-map">Editor</dtile-map-editor>
            </iron-pages>
        </dtile-shell>
    </template>
</dom-module>

<script>
    class DTileApp extends Polymer.Element {
        static get is() { return "dtile-app"; }

        static get properties() {
            return {
                route: String,
                page: String,

                pageData: Object,
                pageContentData: Object,
                projectId: {
                    type: String, computed: "_getProjectId(pageData.pageName, pageContentData.content)"
                },
                mapId: {
                    type: String, computed: "_getMapId(pageData.pageName, pageContentData.content)"
                }
            };
        }

        static get observers() {
            return [
                "_updatePage(pageData, pageContentData)"
            ];
        }

        _updatePage(pageData, pageContentData) {
            if (pageData.pageName === "") {
                // Index redirects to projects dashboard by replacing the current
                // state and updating the app-location element.
                history.replaceState(null, null, "/projects");
                window.dispatchEvent(new CustomEvent("location-changed"));
            } else {
                this.page = pageData.pageName;
            }
        }

        _getProjectId(page, data) { return page === "project" ? data : this.projectViewData; }
        _getMapId(page, data) { return page === "edit-map" ? data : this.mapEditorData; }
    }

    customElements.define(DTileApp.is, DTileApp);
</script>
