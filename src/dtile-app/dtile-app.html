<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../dtile-shell/dtile-shell.html">
<link rel="import" href="projects-view.html">
<link rel="import" href="project-view.html">
<link rel="import" href="../dtile-map-editor/dtile-map-editor.html">

<dom-module id="dtile-app">
    <template>
        <style>
            :host, dtile-shell, iron-pages, iron-pages > * {
                display: block;
                width: 100%;
                height: 100%;
            }

            #file-drop-zone {
                position: fixed;
                top: 0; right: 0; bottom: 0; left: 0;
                width: 100vw;
                height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
            }
        </style>

        <div id="file-drop-zone">
            <iron-icon icon="file-upload"></iron-icon>
            Drop file to import it
        </div>

        <app-location id="location" route="{{route}}"></app-location>
        <app-route
            route="{{route}}"
            pattern="/:pageName"
            data="{{pageData}}"
            tail="{{subroute}}">
        </app-route>

        <dtile-shell>
            <iron-pages selected="[[page]]" attr-for-selected="page">
                <dtile-projects-view page="projects"></dtile-projects-view>
                <dtile-project-view page="project"></dtile-project-view>
                <span page="tilesets">Tilesets</span>
                <dtile-map-editor page="edit-map">Editor</dtile-map-editor>
            </iron-pages>
        </dtile-shell>
    </template>
</dom-module>

<script>
    class DTileApp extends DTile.ReduxMixin(Polymer.Element) {
        static get is() { return "dtile-app"; }

        static get properties() {
            return {
                route: String,
                page: { type: String, statePath: "ui.currentPage" },

                pageData: Object,
                subroute: Object,

                isReady: Boolean
            };
        }

        static get observers() {
            return [
                "_updatePage(pageData, subroute)",
                "_updatePath(page)"
            ];
        }

        static get actions() {
            return {
                setCurrentPage: page => ({ type: "SET_CURRENT_PAGE", payload: page }),
                setCurrentProjectId: id => ({ type: "SET_CURRENT_PROJECT_ID", payload: id }),
                setCurrentMapId: id => ({ type: "SET_CURRENT_MAP_ID", payload: id })
            };
        }

        ready() {
            super.ready();

            const setDropHintVisibility = (visible, preventEvent) => {
                if (preventEvent) {
                    preventEvent.stopPropagation();
                    preventEvent.preventDefault();
                    preventEvent.dataTransfer.dropEffect = "copy";
                }
                this.$["file-drop-zone"].style.opacity = visible ? 1 : 0;
            };

            this.addEventListener("dragover", e => setDropHintVisibility(true, e));
            this.addEventListener("dragleave", e => setDropHintVisibility(false, e));

            this.addEventListener("drop", e => {
                e.stopPropagation();
                e.preventDefault();

                setDropHintVisibility(false);

                const currentPage = this.shadowRoot.querySelector(".iron-selected");
                currentPage.dispatchEvent(new CustomEvent("dtile-file-import", {
                    bubbles: true,
                    detail: {
                        files: [...e.dataTransfer.files]
                    }
                }));
            });

            this.isReady = true;
            this._updatePage(this.pageData, this.subroute);
        }

        _updatePage(pageData, subroute) {
            if (!this.isReady) return;

            if (subroute.path) {
                const id = subroute.path.match(/(\d)$/)[1];
                if (pageData.pageName === "project") {
                    this.dispatch("setCurrentProjectId", id);
                } else if (pageData.pageName === "edit-map") {
                    this.dispatch("setCurrentMapId", id);
                }
            }

            if (pageData.pageName === "") {
                // Index redirects to projects dashboard by replacing the current
                // state and updating the app-location element.
                history.replaceState(null, null, "/projects");
                window.dispatchEvent(new CustomEvent("location-changed"));
            } else {
                if (this.page !== pageData.pageName) {
                    const currentSelected = this.shadowRoot.querySelector(".iron-selected");
                    if (currentSelected) currentSelected.dispatchEvent(new CustomEvent("dtile-page-away"));

                    this.dispatch("setCurrentPage", pageData.pageName);

                    requestAnimationFrame(() => requestAnimationFrame(() =>
                        this.shadowRoot.querySelector(".iron-selected")
                            .dispatchEvent(new CustomEvent("dtile-page-to"))));
                }
            }
        }

        _updatePath(page) {
            let data;
            if (page === "project") data = this.getState().ui.currentProjectId;
            else if (page === "edit-map") data = this.getState().ui.currentMapId;

            this.$.location.path = `/${page}${typeof data !== "undefined" ? `/${data}` : ""}`;
        }
    }

    customElements.define(DTileApp.is, DTileApp);
</script>
