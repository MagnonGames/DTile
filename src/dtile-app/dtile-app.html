<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../../bower_components/app-layout/app-layout.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/all-imports.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<link rel="import" href="../../bower_components/file-input/file-input.html">

<link rel="import" href="../dtile-tilemap-editor/dtile-tilemap-editor.html">
<link rel="import" href="../dtile-tileset-selector/dtile-tileset-selector.html">
<link rel="import" href="../dtile-dialogs/dtile-tileset-import-dialog.html">
<link rel="import" href="../dtile-dialogs/dtile-new-map-dialog.html">
<link rel="import" href="../dtile-layer-list/dtile-layer-list.html">

<dom-module id="dtile-app">
	<template>
		<style>
			/* Google Fonts */
			@font-face {
				font-family: 'Noto Sans';
				font-style: normal;
				font-weight: 400;
				src: local('Noto Sans'), local('NotoSans'), url(https://fonts.gstatic.com/s/notosans/v6/LeFlHvsZjXu2c3ZRgBq9nKCWcynf_cDxXwCLxiixG1c.ttf) format('truetype');
			}

			:host {
				display: block;
				font-family: 'Noto Sans', sans-serif;

				--primary-color: var(--paper-teal-500);
				--accent-color: var(--paper-green-a400);
			}

			#tilemapContainer {
				display: block;
				width: 100%;
				height: 100%;
			}

			#renderer {
				background: #303030;
			}

			app-toolbar {
				color: white;
				background: var(--primary-color);
			}

			paper-icon-button + [main-title] {
				margin-left: 24px;
			}

			footer {
				pointer-events: none;
				position: absolute;
				bottom: 10px;
				left: 0; right: 0;
				text-align: center;
				color: white;
				opacity: 0.6;
			}
		</style>
		<style is="custom-style" include="iron-positioning"></style>

		<app-drawer-layout fullbleed>
			<app-drawer swipe-open align="end">
				<paper-listbox selectable=".nothing">
					<paper-item>
						<paper-checkbox checked="{{showOutline}}">Show Wireframe</paper-checkbox>
					</paper-item>
					<paper-item>
						<paper-radio-group selected="{{currentTool}}">
							<paper-radio-button name="pen">Pen</paper-radio-button>
							<paper-radio-button name="selection">Selection</paper-radio-button>
						</paper-radio-group>
					</paper-item>
				</paper-listbox>
				<dtile-layer-list layers="{{_map.layers}}" id="layerList"></dtile-layer-list>
				<paper-input value="{{currentTileset}}" type="number"></paper-input>
				<dtile-tileset-selector map="[[_map]]" selected-tile-area="{{selectedTileArea}}"
					tileset-id="[[currentTileset]]"></dtile-tileset-selector>
			</app-drawer>

			<app-drawer id="mainDrawer" swipe-open>
				<paper-listbox selectable=".nothing">
					<paper-icon-item on-tap="requestCreateMap">
						<iron-icon icon="add" item-icon></iron-icon>
						New Map
					</paper-icon-item>
					<paper-icon-item>
						<iron-icon icon="add" item-icon></iron-icon>
						<file-input id="mapFileInput" accept="application/json"
							extensions="[&quot;json&quot;]" max-files="1" on-change="updateMap">
						</file-input>
						Import Map
					</paper-icon-item>
					<paper-icon-item>
						<iron-icon icon="add" item-icon></iron-icon>
						<file-input id="tilesetFileInput" accept="image/*,application/json"
						 	max-files="1" on-change="requestTilesetImport">
						</file-input>
						Import Tileset
					</paper-icon-item>
				</paper-listbox>
				<paper-spinner id="mapSpinner"></paper-spinner>
			</app-drawer>

			<app-header-layout fullbleed>
				<app-header fixed shadow>
					<app-toolbar>
						<paper-icon-button icon="menu" on-tap="toggleMainDrawer"></paper-icon-button>
						<div main-title>DTile</div>
					</app-toolbar>
				</app-header>

				<div id="tilemapContainer">
					<dtile-tilemap-editor id="renderer" map="[[_map]]"
						outline="[[showOutline]]" current-tool="[[currentTool]]"
						current-tile-area="[[selectedTileArea]]">
					</dtile-tilemap-editor>
				</div>

				<footer>
					Build: [[version]]
				</footer>
			</app-header-layout>
		</app-drawer-layout>

		<dtile-tileset-import-dialog id="tilesetImportDialog"></dtile-tileset-import-dialog>
		<dtile-new-map-dialog id="mapCreateDialog"></dtile-new-map-dialog>
	</template>

	<script src="../../node_modules/dtile-tilemap/out/js/build.js"></script>

	<script>
		/* globals dtileTilemap */
		Polymer({
			is: "dtile-app",

			properties: {
				_map: Object,
				showOutline: Boolean,
				currentTool: {
					type: String,
					value: "pen"
				},
				currentTileset: {
					type: Number,
					value: 0
				},

				version: {
					type: String,
					value: "__VERSION__",
					readOnly: true
				}
			},

			listeners: {
				"tilesetImportDialog.tileset-import": "addTileset",
				"mapCreateDialog.map-create": "createNewMap",
				"layerList.layers-changed": "updateLayers",
				"add-layer": "_addLayer"
			},

			toggleMainDrawer() {
				this.$.mainDrawer.toggle();
			},

			updateMap() {
				const mapFile = this.$.mapFileInput.files[0];
				if (!mapFile) return;

				this.$.mapSpinner.active = true;

				const fileReader = new FileReader();

				fileReader.onload = () => {
					const mapObject = JSON.parse(fileReader.result);

					this._map = new dtileTilemap.TileMap(mapObject);
					this.$.mapSpinner.active = false;
					this.$.mainDrawer.close();
				};

				fileReader.readAsText(mapFile);
			},

			updateLayers() {
				this.$.renderer.fire("update-map");
			},

			requestCreateMap() {
				this.$.mapCreateDialog.open();
				this.$.mainDrawer.close();
			},

			requestTilesetImport() {
				this.$.tilesetImportDialog.setImage(this.$.tilesetFileInput.files[0]);
				this.$.tilesetImportDialog.open();
				this.$.mainDrawer.close();
			},

			createNewMap(e) {
				this._map = new dtileTilemap.TileMap(e.detail);
			},

			addTileset(e) {
				const tileset = new dtileTilemap.TileSet({
					name: e.detail.name,
					type: "image",
					path: e.detail.imageURL
				});
				this._map.addTileset(tileset);
				this.$.renderer.fire("tileset-added");
			},

			_addLayer(e) {
				this._map.createLayer({
					name: e.detail.name
				});
				this.updateLayers();
			}
		});
	</script>
</dom-module>
