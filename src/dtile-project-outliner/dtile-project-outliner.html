<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../dtile-outliner/dtile-outliner.html">
<link rel="import" href="../dtile-outliner/dtile-outliner-entry.html">
<link rel="import" href="../dtile-outliner/dtile-outliner-group.html">

<dom-module id="dtile-project-outliner">
	<template>
		<dtile-outliner>
			<template is="dom-repeat" items="{{projects}}">
				<dtile-project-repeater group="{{item}}"
					on-rename="_rename" on-remove="_remove",
					on-properties="_properties"></dtile-project-repeater>
			</template>
		</dtile-outliner>
	</template>

	<script>
		Polymer({
			is: "dtile-project-outliner",

			properties: {
				projects: {
					type: Array,
					value: () => []
				}
			},

			_rename(e) {
				console.log("STUB: rename", e.model.item.name, e.detail.mapName);
			},
			_remove(e) {
				console.log("STUB: remove", e.model.item.name, e.detail.mapName);
			},
			_properties(e) {
				console.log("STUB: properties", e.model.item.name, e.detail.mapName);
			}
		});
	</script>
</dom-module>

<dom-module id="dtile-project-repeater">
	<template>
		<dtile-outliner-group>
			<span class="parent">[[group.name]]</span>
			<template is="dom-repeat" items="{{_children}}">
				<template is="dom-if" if="[[item.children]]">
					<dtile-project-repeater group="[[item]]"></dtile-project-repeater>
				</template>

				<template is="dom-if" if="[[!item.children]]">
					<dtile-outliner-entry on-select="_fireSelect">
						<span class="text">[[item.name]]</span>
						<div class="icons">
							<paper-menu-button>
								<paper-icon-button icon="more-vert" on-tap="_handleMenuTap"
									class="dropdown-trigger"></paper-icon-button>
								<paper-menu class="dropdown-content">
									<paper-item on-tap="_rename">Rename</paper-item>
									<paper-item on-tap="_remove">Remove</paper-item>
									<paper-item on-tap="_properties">Properties</paper-item>
								</paper-menu>
							</paper-menu-button>
						</div>
					</dtile-outliner-entry>
				</template>
			</template>
		</dtile-outliner-group>
	</template>

	<script>
		Polymer({
			is: "dtile-project-repeater",

			properties: {
				group: {
					type: Object,
					value: () => ({
						name: "",
						children: []
					})
				},

				_children: {
					type: Array,
					computed: "_computeChildren(group.*)"
				}
			},

			_computeChildren(change) {
				return change.base.getOutlined();
			},

			_fireSelect(e) {
				e.stopPropagation();

				const item = e.detail.item || e.model.item;
				this.fire("select", { parentName: this.group.name, item });
			},

			_handleMenuTap(e) {
				e.stopPropagation();
				e.target.parentElement.open();
			},

			_rename(e) {
				this.fire("rename", { mapName: e.model.item.name });
			},
			_remove(e) {
				this.fire("remove", { mapName: e.model.item.name });
			},
			_properties(e) {
				this.fire("properties", { mapName: e.model.item.name });
			}
		});
	</script>
</dom-module>
