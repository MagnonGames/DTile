<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="dtile-selection">
	<template>
		<style>
			:host, #container {
				display: block;
				position: absolute;
				top: 0; right: 0; bottom: 0; left: 0;
				width: 100%;
				height: 100%;
				overflow: hidden;
			}

			#selection {
				position: absolute;
				background-color: var(--accent-color);
				opacity: 0;
				transition: opacity 0.15s ease-in-out;
			}
		</style>
		<div id="container">
			<span id="selection"></span>
		</div>
	</template>

	<script>
		Polymer({
			is: "dtile-selection",

			properties: {
				enabled: {
					type: Boolean,
					value: false,
					reflectToAttribute: true
				},
				selecting: {
					type: Boolean,
					value: false,
					reflectToAttribute: true,
					notify: true,
					readOnly: true
				},

				opacity: {
					type: Number,
					value: 0.5,
					reflectToAttribute: true
				}
			},

			listeners: {
				"container.track": "handleTrack",
				"container.tap": "handleTap"
			},

			observers: [
				"onEnable(enabled)"
			],

			get color() {
				const computedStyle = getComputedStyle(this.$.selection);
				return computedStyle.getPropertyValue("background-color");
			},

			onEnable(enabled) {
				this.style.display = enabled ? "block" : "none";
			},

			handleTrack(e) {
				if (!this.enabled) return;

				e.preventDefault();
				e.stopPropagation();

				const pos = this._toLocalPos({ x: e.detail.x, y: e.detail.y });

				if (e.detail.state === "start") {
					this.selecting = true;
					this.startPosition = pos;
					this.$.selection.style.opacity = this.opacity;
				} else if (e.detail.state === "end") {
					this.selecting = false;
					this.$.selection.style.opacity = 0;
					const rect = this._getSelectionRectangle(this.startPosition, pos);

					this._fireSelectEvent(rect);
				} else if (e.detail.state === "track") {
					const rect = this._getSelectionRectangle(this.startPosition, pos);
					this.$.selection.style.left = `${rect.x}px`;
					this.$.selection.style.top = `${rect.y}px`;
					this.$.selection.style.width = `${rect.width}px`;
					this.$.selection.style.height = `${rect.height}px`;
				}
			},

			handleTap() {
				this._fireSelectEvent({
					x: 0, y: 0, width: 0, height: 0
				});
			},

			_toLocalPos(pos) {
				const rect = this.$.container.getBoundingClientRect();
				pos.x -= rect.left;
				pos.y -= rect.top;
				return pos;
			},

			_getSelectionRectangle(startPos, endPos) {
				const x = Math.min(startPos.x, endPos.x);
				const y = Math.min(startPos.y, endPos.y);
				const width = Math.max(startPos.x, endPos.x) - x;
				const height = Math.max(startPos.y, endPos.y) - y;
				return { x, y, width, height };
			},

			_fireSelectEvent(rect) {
				this.fire("select", {
					x: rect.x, y: rect.y,
					width: rect.width, height: rect.height
				});
			}
		});
	</script>
</dom-module>
