<script src="../node_modules/localforage/dist/localforage.min.js"></script>

<script>
    /* globals localforage */
    DTile.storage = new class DTileStorage {
        constructor() {
            this.restore();
        }

        async restore() {
            const state = await localforage.getItem("state");

            if (!state) return;

            await Promise.all(Object.keys(state.entities.tilesets).map(async tilesetId => {
                if (state.entities.tilesets[tilesetId].tilesetType === "test") return;

                state.entities.tilesets[tilesetId].url = await this.getTilesetImageUrl(tilesetId);
            }));

            DTile.store.dispatch({
                type: "REPLACE",
                payload: state
            });
        }

        async save() {
            await localforage.setItem("state", DTile.store.getState());
        }

        async addTilesetImage(tilesetId, url) {
            const imageData = await fetch(url);
            const imageBlob = await imageData.blob();

            await localforage.setItem(`tilesetImage-${tilesetId}`, imageBlob);
        }

        async getTilesetImageUrl(tilesetId) {
            return URL.createObjectURL(await localforage.getItem(`tilesetImage-${tilesetId}`));
        }
    }();
</script>
