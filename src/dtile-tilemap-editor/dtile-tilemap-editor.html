<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../dtile-three-renderer/dtile-three-renderer.html">
<link rel="import" href="../dtile-selection/dtile-selection.html">
<link rel="import" href="../dtile-scroll-behavior/dtile-scroll-behavior.html">
<link rel="import" href="../dtile-tile-select-behavior/dtile-tile-select-behavior.html">

<dom-module id="dtile-tilemap-editor">
	<template>
		<style>
			:host {
				display: block;
				position: relative;
				width: 100%;
				height: 100%;
				background: transparent;
			}

			dtile-selection {
				z-index: 10;
			}
		</style>
		<dtile-selection id="selection" enabled=[[_isSelecting(currentTool)]]></dtile-selection>
		<dtile-three-renderer id="renderer" map="[[map]]" outline="[[outline]]"
			pan-x="[[panX]]" pan-y="[[panY]]" zoom="[[zoom]]"></dtile-three-renderer>
	</template>

	<script>
		/* globals DTile */
		Polymer({
			is: "dtile-tilemap-editor",

			properties: {
				map: Object,
				outline: Boolean,

				currentTool: {
					type: String,
					value: "pen",
					reflectToAttribute: true
				}
			},

			behaviors: [
				DTile.ScrollBehavior,
				DTile.TileSelectBehavior
			],

			listeners: {
				"renderer.tap": "rendererTap"
			},

			_isSelecting() {
				return this.currentTool === "selection";
			},

			rendererTap(e) {
				if (this.currentTool === "pen") {
					const pos = this.$.renderer.getTileAtMouse(this._toLocalRendererPos(e.detail), 0);
					if (!pos) return;
					const tile = this.map.layers[0].getTileArea(pos.x, pos.y, 1, 1).tiles[0];
					if (tile) tile.tileId = -1;
					this.$.renderer.update({ tiles: true });
				}
			},

			getTilePosition(x, y, transformToLocal) {
				return this.$.renderer.getTileAtMouse(
					transformToLocal
						? this._toLocalRendererPos({ x, y })
						: { x, y },
					0
				);
			},

			setTileSelected(x, y, selected) {
				this.$.renderer.setTint(x, y, 0, selected ? this.$.selection.color : false);
			},

			_toLocalRendererPos(pos) {
				const rect = this.$.renderer.getBoundingClientRect();
				pos.x -= rect.left;
				pos.y -= rect.top;
				return pos;
			}
		});
	</script>
</dom-module>
