<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../dtile-tilemap-viewer/dtile-tilemap-viewer.html">
<link rel="import" href="../dtile-tileset-viewer/dtile-tileset-viewer.html">

<link rel="import" href="./paper-icon-radio-group.html">
<link rel="import" href="./layer-list.html">
<link rel="import" href="./tileset-selector.html">

<dom-module id="dtile-map-editor">
    <template>
        <style>
            #container {
                width: 100%;
                height: 100%;
                position: relative;
            }

            #sheet {
                position: absolute;
                top: 20px;
                left: 20px;
                border-radius: 2px;
                background: var(--page-background-color);
                @apply --shadow-elevation-2dp;
            }

            #sheet > paper-icon-radio-group {
                --paper-icon-selected-color: rgba(255, 255, 255, 0.2);
            }

            #sheet > paper-icon-radio-group > paper-icon-button {
                color: white;
            }
        </style>

        <div id="container">
            <dtile-tilemap-viewer id="viewer"
                map="[[map]]"
                tilesets="[[tilesets]]"
                selection="[[mapSelection]]">
            </dtile-tilemap-viewer>

            <div id="sheet">
                <paper-icon-radio-group selected="one">
                    <paper-icon-button icon="polymer" name="one"></paper-icon-button>
                    <paper-icon-button icon="polymer" name="two"></paper-icon-button>
                    <paper-icon-button icon="polymer" name="three"></paper-icon-button>
                    <paper-icon-button icon="polymer" name="four"></paper-icon-button>
                </paper-icon-radio-group>
                <dtile-layer-list></dtile-layer-list>

                <dtile-tileset-selector id="tileset-selector"
                    selected-id="[[currentTilesetId]]" tilesets="[[tilesets]]">
                </dtile-tileset-selector>
                <dtile-tileset-viewer id="tileset-viewer"
                    tileset-id="[[currentTilesetId]]" tilesets="[[tilesets]]"
                    selection="[[tilesetSelection]]">
                </dtile-tileset-viewer>
            </div>
        </div>
    </template>
</dom-module>

<script>
    class DTileMapEditor extends DTile.ReduxMixin(Polymer.Element) {
        static get is() { return "dtile-map-editor"; }

        static get properties() {
            return {
                map: {
                    type: Object,
                    statePath(state) {
                        return state.entities.maps[state.ui.currentMapId];
                    }
                },

                tilesets: {
                    type: Object,
                    statePath(state) {
                        const projectId = state.ui.currentProjectId;
                        const tilesets = {};
                        if (!projectId) return;
                        state.entities.projects[projectId].tilesetIds.forEach(tilesetId => {
                            tilesets[tilesetId] = state.entities.tilesets[tilesetId];
                        });
                        return tilesets;
                    }
                },

                currentTilesetId: {
                    type: String,
                    statePath: "ui.currentTilesetId"
                },

                mapSelection: { type: Array, statePath: "ui.mapSelection" },
                tilesetSelection: { type: Array, statePath: "ui.tilesetSelection" }
            };
        }

        static get actions() {
            return {
                setCurrentTilesetID(id) {
                    return {
                        type: "SET_CURRENT_TILESET_ID",
                        payload: id
                    };
                }
            };
        }

        ready() {
            super.ready();

            this.addEventListener("dtile-page-to", () => {
                this.$.viewer.resetViewValues();
                this.$.viewer.updateSize();
                this.$.viewer.updateCamera();

                this.$["tileset-viewer"].resetView();
            });

            this.$["tileset-selector"].addEventListener("tileset-selected", e => {
                e.stopPropagation();
                this.dispatch("setCurrentTilesetID", e.detail);
            });
        }
    }

    customElements.define(DTileMapEditor.is, DTileMapEditor);
</script>
