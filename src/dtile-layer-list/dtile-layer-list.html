<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">

<dom-module id="dtile-layer-list">
	<template>
		<style>
			:host {
				display: block;
				position: relative;
				overflow: hidden;
			}

			#header {
				display: flex;
				padding-left: 16px;
				padding-right: 8px;
			}

			#title {
				text-align: left;
				flex-grow: 1;
				display: flex;
				align-items: center;
				font-size: 14px;
				color: rgba(0, 0, 0, 0.45);
				font-weight: bold;
			}

			#items {
				width: 100%;
				height: 100%;
				position: relative;
			}

			.layerItem {
				user-select: none;
				padding-right: 0;
				cursor: default;
				box-sizing: border-box;
				transition: background 0.2s, color 0.2s;
			}

			.layerItem[selected] {
				background: var(--primary-color);
				color: white;
			}

			.layerItem[selected] > paper-input, .layerItem[selected] paper-icon-button {
				color: white;
			}

			.layerItem > paper-ripple {
				color: var(--primary-color);
			}

			.layerName {
				text-align: left;
				flex-grow: 1;
			}

			#renameDialog > paper-input {
				text-align: left;
			}

			paper-icon-button {
				color: rgba(0, 0, 0, 0.54);
			}
		</style>

		<div id="header">
			<span id="title">Layers</span>
			<paper-icon-button icon="add" on-tap="_addLayer"></paper-icon-button>
		</div>

		<div id="items" role="listbox">
			<template id="itemsRepeater" is="dom-repeat" items="[[_reverseLayers]]">
				<paper-item index$=[[index]] class="layerItem" selected$="{{_isSelected(index, currentSelected)}}"
					on-tap="_changeSelected">
					<span class="layerName">[[item.name]]</span>
					<paper-menu-button horizontal-align="right" class="layerMenuButton" close-on-activate>
						<paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
						<paper-menu class="dropdown-content">
							<paper-item on-tap="_requestRename">Rename</paper-item>
							<paper-item on-tap="_handleRemove">Remove</paper-item>
						</paper-menu>
					</paper-menu-button>
					<paper-ripple></paper-ripple>
				</paper-item>
			</template>
		</div>

		<paper-dialog id="renameDialog" opened="{{_renameDialogOpened}}">
			<h2>Rename Layer</h2>
			<paper-input id="renameInput" label="Name" autofocus auto-validate
				error-message="Layer has to have a name." required
				value="{{_newLayerName}}"></paper-input>
			<div class="buttons">
				<paper-button dialog-dismiss>Cancel</paper-button>
				<paper-button dialog-confirm disabled="[[!_renameInputValid]]"
					on-tap="_handleRename">Rename</paper-button>
			</div>
		</paper-dialog>
	</template>

	<script>
		Polymer({
			is: "dtile-layer-list",

			properties: {
				layers: Array,

				currentSelected: {
					type: Number,
					notify: true
				},

				_reverseLayers: {
					type: Array,
					computed: "_getReverseLayers(layers.*)",
					notify: true
				},

				_currentDragging: Object,
				_currentDraggingIndex: Number,
				_topMouseOffset: Number,
				_topElementOffset: Number,

				_renameDialogOpened: Boolean,
				_renamingLayerIndex: Object,
				_newLayerName: String,
				_renameInputValid: Boolean
			},

			listeners: {
				"items.track": "_handleTrack"
			},

			observers: [
				"_validateRenameInput(_newLayerName)"
			],

			_handleTrack(e) {
				if (e.detail.state === "start") {
					const clientRect = this.$.items.getBoundingClientRect();
					let el = e.target;
					while (el) {
						if (el.tagName === "PAPER-ITEM") break;
						el = el.parentElement;
					}
					this._currentDragging = el;
					this._topMouseOffset = e.detail.y;
					this._topElementOffset = this._currentDragging.getBoundingClientRect().top - clientRect.top;

					this.$.items.style.width = `${clientRect.width}px`;
					this.$.items.style.height = `${clientRect.height}px`;

					[...this.$.items.children].reverse().forEach(child => {
						if (child.tagName !== "PAPER-ITEM") return;
						if (child === this._currentDragging) {
							this._currentDraggingIndex = child.getAttribute("index");
						}
						this._setStatic(child, clientRect);
					});
				} else if (e.detail.state === "track") {
					const totalOffset = e.detail.y - this._topMouseOffset + this._topElementOffset;
					this._currentDragging.style.top = `${totalOffset}px`;
				} else if (e.detail.state === "end") {
					for (let element of this.$.items.children) {
						if (element.tagName !== "PAPER-ITEM") continue;
						this._releaseStatic(element);
					}
					this.$.items.style.width = "auto";
					this.$.items.style.height = "auto";

					const finalTop = e.detail.y - this._topMouseOffset + this._topElementOffset;

					let newIndex = finalTop / this.$.items.children[0].getBoundingClientRect().height;
					newIndex = Math.min(Math.max(Math.round(newIndex), 0), this.layers.length - 1);
					this._moveLayer(this._currentDraggingIndex, newIndex);
				}
			},

			_handleRemove(e) {
				this._removeLayer(e.model.index);
			},

			_requestRename(e) {
				this._newLayerName = e.model.item.name;
				this._renamingLayerIndex = e.model.index;
				this._renameDialogOpened = true;
			},

			_handleRename() {
				// Polymer doesn't update computed properties if you just set a
				// sub-property. This was the best hack I managed to find for it.
				const index = this._getReverseIndex(this._renamingLayerIndex);
				const layer = this.splice("layers", index, 1);
				layer.name = this._newLayerName;
				this.splice("layers", index, 0, layer);

				this._fireChangeEvent();
			},

			_validateRenameInput(name) {
				this._renameInputValid = name.length > 0;
			},

			_setStatic(element, parentRect) {
				const rect = element.getBoundingClientRect();
				element.style.top = `${rect.top - parentRect.top}px`;
				element.style.left = "0px";
				element.style.width = "100%";
				element.style.position = "absolute";
			},

			_releaseStatic(element) {
				element.style.position = "relative";
				element.style.top = "0px";
				element.style.width = "auto";
			},

			_moveLayer(startIndex, newIndex) {
				if (startIndex === newIndex) return;

				// Since layers are rendered in reverse order, we need to respect
				// that here.
				startIndex = this._getReverseIndex(startIndex);
				newIndex = this._getReverseIndex(newIndex);

				const layer = this.splice("layers", startIndex, 1)[0];
				this.splice("layers", newIndex, 0, layer);

				// Move the selected index if needed
				if (this.currentSelected === startIndex) this.currentSelected = newIndex;
				else if (this.currentSelected === newIndex) this.currentSelected = startIndex;

				this._fireChangeEvent();
			},

			_removeLayer(index) {
				index = this._getReverseIndex(index);

				this.splice("layers", index, 1);

				this._fireChangeEvent();
			},

			_addLayer() {
				let count = 1;
				this.layers.forEach(layer => {
					if (layer.name.indexOf("Layer") === 0) count++;
				});
				this.fire("add-layer", { name: `Layer ${count}` });

				// Force update
				const layers = this.layers;
				this.set("layers", []);
				this.set("layers", layers);

				this.currentSelected = this.layers.length - 1;

				this.fire("map-changed");
			},

			_getReverseIndex(index) {
				return index * -1 + this.layers.length - 1;
			},

			_getReverseLayers() {
				return this.layers.map((_, index, layers) => {
					return layers[index * -1 + layers.length - 1];
				});
			},

			_isSelected(index, selected) {
				// For some reason (and I have no idea why), comparing with ===
				// didn't work here. Object.is seems to get the job done, but it
				// does feel a bit hacky. ¯\_(ツ)_/¯
				return Object.is(this._getReverseIndex(index), selected);
			},

			_changeSelected(e) {
				this.currentSelected = this._getReverseIndex(e.model.index);
			},

			_fireChangeEvent() {
				this.fire("layers-changed");
				this.fire("map-changed");
			}
		});
	</script>
</dom-module>
